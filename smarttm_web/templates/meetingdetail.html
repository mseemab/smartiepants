{% extends "basefile.html" %}


{% block title %}Meeting Details of {{ meeting.meeting_date }} - SMARTTM {%endblock%}
{% block body_block%}

		<!-- <br /><br /> -->
		<div class="container-fluid" >
			<br><br>
			<div class="row">
				<div class="col-sm">
					<h3>Meeting Details of {{ meeting.meeting_date }}</h3>
				</div>
				<div class="col-sm" style="text-align:right;">
					<h3>
					<a href="{% url 'meeting_detail' meeting.pk %}"><button type="button" class="btn btn-outline-success" >
					  <i class="fa fa-sync"></i> Refresh
					</button></a>

					<button type="button" class="btn btn-outline-primary btn-rounded" data-toggle="modal" data-target="#ImportMeetingData">
					  <i class="fa fa-file-excel"></i> Import Meeting Data
					</button>
					</h3>
				</div>

				<!-- Import Modal -->
					<div class="modal fade" id="ImportMeetingData" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<form action="{% url 'import_meeting_data' %}" method="POST" enctype="multipart/form-data">
									<div class="modal-header">
										<h5 class="modal-title" id="exampleModalLabel">Import Meeting Data</h5>
										<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body">
										{% csrf_token %}
										<div class="alert alert-info">
										  <strong>Info!</strong> Make sure the import file is <u>.xlsx</u> file and according to the template.
										</div>
										<br>

										<br>
										<b>Select File :</b>
										<input type="file" name="importfile" required class="form-data" />
										<input type="hidden" name="meeting_id" required class="form-data" value = "{{meeting.pk}}">
										<br><br>

										<br>

									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-primary">Import Data</button>
										<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
									</div>
								</form>
							</div>
						</div>
					</div>
			</div>

			<hr />	
			<br><br>



			<div class="row">

				<div class="col-sm" >
					<center><h4>Speeches Detail </h4></center>
					<br>
					<div class="table-responsive">

							<table  class="table table-bordered" >
							<thead>
								<tr>
									<td> # </td>
									<th>Member Name</th>
									<th>Speech Type</th>
									<th>Total Duration</th>
									<th>AH Counts</th>
									<th>Vote Counts</th>
									<th>Action</th>

								</tr>
							</thead>
							<tbody>
								{% for part_Obj in speech_part %}
									<tr id="hide-row-{{ part_Obj.id }}">
										<td>{{ forloop.counter }}</td>
										<td>{{ part_Obj.member.user.full_name }}</td>
										<td>{{ part_Obj.participation_type.name }}</td>
										<td>{{ part_Obj.time_seconds }}</td>
										<td>{{ part_Obj.ah_count }}</td>
										<td>{{ part_Obj.vote_count }}</td>
										<td><a><i class="far fa-edit"></i></a>&nbsp&nbsp&nbsp<a data-toggle="modal" data-target="#DeletePrompt" data-id="{{ part_Obj.id }}"><i class="far fa-trash-alt" style="color: maroon"></i></a></td>
									</tr>
								{% endfor %}
							</tbody>
							</table>
						</div>

				</div>
				
			</div>
            <div class="row">
				<div class="col-sm" >
				<center><h4>Basic Roles</h4></center>
				<br>
					<div class="table-responsive">


						<table  class="table table-bordered" >
							<thead>
								<tr>
									<td> # </td>
									<th>Role Name</th>
									<th>Performed By</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								{% for part_Obj in role_basic_part %}
									<tr id="hide-row-{{ part_Obj.id }}">
										<td>{{ forloop.counter }}</td>
										<td>{{ part_Obj.participation_type.name }}</td>
                                        <td>{{ part_Obj.member.user.full_name }}</td>
										<td><a><i class="far fa-edit"></i></a>&nbsp&nbsp&nbsp<a data-toggle="modal" data-target="#DeletePrompt" data-id="{{ part_Obj.id }}"><i class="far fa-trash-alt" style="color: maroon"></i></a></td>
										</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
				<div class="col-sm" >
				<center><h4>Advanced Roles</h4></center>
				<br>
					<div class="table-responsive">


						<table  class="table table-bordered" >
							<thead>
								<tr>
									<td> # </td>
									<th>Role Name</th>
									<th>Performed By</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								{% for part_Obj in role_advanced_part %}
									<tr  id="hide-row-{{ part_Obj.id }}">
										<td>{{ forloop.counter }}</td>
										<td>{{ part_Obj.participation_type.name }}</td>
                                        <td>{{ part_Obj.member.user.full_name }}</td>
										<td><a><i class="far fa-edit"></i></a>&nbsp&nbsp&nbsp<a data-toggle="modal" data-target="#DeletePrompt" data-id="{{ part_Obj.id }}"><i class="far fa-trash-alt" style="color: maroon"></i></a></td>
										</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>

			</div>
			<div class="row">
				<div class = 'col-sm'>
					<center><h4>Attendance Details</h4></center>
					<br>
				<div class="table-responsive">


						<table  class="table table-bordered" id = "attendances" >
							<thead>
								<tr>
									<th> # </th>

									<th>Member Name</th>
									<th>Present</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for att_record in attendance %}
									<tr>
										<td>{{ forloop.counter }}</td>
                                        <td>{{ att_record.member.user.full_name }}</td>
										<td id = "attendance-{{ att_record.pk }}">
											{% if att_record.present %}<i class="fas fa-check"></i> Present{% endif %}
											{% if att_record.present == False %}<i class="fas fa-times"></i> Absent{% endif %}
										</td>
										<td id = "actions-{{ att_record.pk }}">
<!--											<a onClick="ToggleAttendance({{ att_record.pk }})">-->
<!--												{% if att_record.present %}Mark Absent{% endif %}-->
<!--												{% if att_record.present == False %}Mark Present{% endif %}-->
<!--											</a>-->
											<button type="button" class="btn btn-primary btn-sm" onclick="ToggleAttendance({{ att_record.pk }})">
												{% if att_record.present %}Mark <i class="fas fa-times"></i>{% endif %}
												{% if att_record.present == False %}Mark <i class="fas fa-check"></i>{% endif %}
											</button>
										</td>
										</tr>
								{% endfor %}
							</tbody>
						</table>
				</div>
			</div>
			</div>
		</div>

		
		<!-- Modal -->

		<!--Prompt Modal-->
			<div class="modal" tabindex="-1" role="dialog" id="DeletePrompt">
			  <div class="modal-dialog" role="document">
				<div class="modal-content">
				  <div class="modal-header">
					<h5 class="modal-title">Delete Participation</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					  <span aria-hidden="true">&times;</span>
					</button>
				  </div>
				  <div class="modal-body">
					<p>Are you sure you want to delete this participation?</p>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-danger" id="deleteButton">Delete</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				  </div>
				</div>
			  </div>
			</div>
		<!--	End Prompt Modal	-->
		<script type="text/javascript">
			csrftoken = Cookies.get('csrftoken')

			function csrfSafeMethod(method) {
				// these HTTP methods do not require CSRF protection
				return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
			}
			$.ajaxSetup({
					beforeSend: function(xhr, settings) {
						if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
							xhr.setRequestHeader("X-CSRFToken", csrftoken);
						}
					}
				});
			function ToggleAttendance(AttendanceID){
				console.log(AttendanceID)
				 
				 
				$.get( "/api/toggleattendance/"+AttendanceID+"/",
				function( data ) {
				console.log(data)

				 if (data.status = 'success'){

				 	if (data.present){
				 		document.getElementById('actions-'+AttendanceID.toString()).innerHTML = '<button type="button" class="btn btn-primary btn-sm" onclick="ToggleAttendance(' + AttendanceID.toString() + ')">Mark <i class="fas fa-times"></i></button>';
				 		document.getElementById('attendance-'+AttendanceID.toString()).innerHTML = '<i class="fas fa-check"></i> Present'

				 	}
				 	else {
				 		document.getElementById('actions-'+AttendanceID.toString()).innerHTML = '<button type="button" class="btn btn-primary btn-sm" onclick="ToggleAttendance(' + AttendanceID.toString() + ')">Mark <i class="fas fa-check"></i></button>';
				 		document.getElementById('attendance-'+AttendanceID.toString()).innerHTML = '<i class="fas fa-times"></i> Absent'
				 	}

				};
			})
			}

			function DeleteParticipation(ParticipationID){
				$.ajax({
				data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
				url: "/api/participation/"+ParticipationID+"/",
				type: 'DELETE',
				success: function(data){
				if (data.status == 'success'){

					$('#DeletePrompt').modal('hide');
					document.getElementById("hide-row-"+ParticipationID).style.display = "none";
				}
				}
			});
			}

			$(document).ready(function() {
				$('#attendances').dataTable({
					"bPaginate": false,

				});
			} );

			$('#DeletePrompt').on('show.bs.modal', function (event) {
				  let button = $(event.relatedTarget)
				  let id = button.data('id') // Extract info from data-* attributes
				  var modal = $(this)
				  modal.find('#deleteButton').attr('onClick', 'DeleteParticipation('+id+')');
				})


		</script>

{%endblock%}